{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - {{ current_brand.name }}</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/bootstrap-icons.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/theme.css' %}" rel="stylesheet">
    <link href="{% static 'css/designer.css' %}" rel="stylesheet">
    <link rel="icon" type="image/png" href="{% static 'favicon.png' %}">

    <!-- Google Fonts -->
    {% if fonts_list %}
    <link
        href="https://fonts.googleapis.com/css2?{% for font in fonts_list %}family={{ font|urlencode }}:wght@400;700{% if not forloop.last %}&{% endif %}{% endfor %}&display=swap"
        rel="stylesheet">
    {% endif %}

    <!-- Preconnect for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>

<body>

    <div id="designer-container" x-data>
        <!-- Loading Overlay -->
        <div id="loading-overlay" x-show="$store.designer.isLoading" x-transition>
            <div class="loading-content">
                <div class="spinner-border text-light mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading 3D Designer...</p>
            </div>
        </div>

        <!-- Fixed Brand Logo -->
        <div class="fixed-brand">
            <img src="{% if current_brand.logo_url %}{{ current_brand.logo_url }}{% else %}{% static 'logo-dark.png' %}{% endif %}"
                alt="{% if current_brand %}{{ current_brand.name }}{% else %}Designer{% endif %}">
            <h1>3D Designer</h1>
        </div>

        <!-- Left Toolbar -->
        <div class="left-toolbar"
            <!-- View Controls -->
            <div class="toolbar-group">
                <button class="toolbar-btn" @click="$store.designer.rotateView('front')" title="Front View">
                    <i class="bi bi-square"></i>
                </button>
                <button class="toolbar-btn" @click="$store.designer.rotateView('back')" title="Back View">
                    <i class="bi bi-square-fill"></i>
                </button>
                <button class="toolbar-btn" @click="$store.designer.rotateView('left')" title="Left View">
                    <i class="bi bi-caret-left-square"></i>
                </button>
                <button class="toolbar-btn" @click="$store.designer.rotateView('right')" title="Right View">
                    <i class="bi bi-caret-right-square"></i>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Rotation Controls -->
            <div class="toolbar-group">
                <button class="toolbar-btn" @click="$store.designer.rotateCamera('left')" title="Rotate Left">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
                <button class="toolbar-btn" @click="$store.designer.rotateCamera('right')" title="Rotate Right">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Zoom Controls -->
            <div class="toolbar-group">
                <button class="toolbar-btn" @click="$store.designer.zoomCamera('in')" title="Zoom In">
                    <i class="bi bi-zoom-in"></i>
                </button>
                <button class="toolbar-btn" @click="$store.designer.zoomCamera('out')" title="Zoom Out">
                    <i class="bi bi-zoom-out"></i>
                </button>
            </div>

            <!-- Tutorials -->
            <div class="toolbar-group">
                <button class="toolbar-btn" @click="window.open('/support', '_blank')" title="Tutorials">
                    <i class="bi bi-question-circle"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- 3D Viewer -->
            <div id="viewer-container">
                <div id="canvas-container"></div>

                <!-- Background Selector (only for brands with backgrounds) -->
                {% if current_brand and current_brand.id %}
                <div class="viewer-background-selector">
                    <div class="dropdown">
                        <button class="background-selector-btn dropdown-toggle" type="button" id="backgroundDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false" title="Change Background">
                            <i class="bi bi-image me-2"></i>
                            <span>Background</span>
                        </button>
                        <ul class="dropdown-menu background-dropdown dropdown-menu-end"
                            aria-labelledby="backgroundDropdown">
                            <li>
                                <h6 class="dropdown-header">Background</h6>
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="setBackground(null)">
                                    <div class="background-option">
                                        <div
                                            class="background-thumbnail bg-light d-flex align-items-center justify-content-center">
                                            <i class="bi bi-slash-circle text-muted"></i>
                                        </div>
                                        <span>None</span>
                                    </div>
                                </a></li>
                            <!-- Additional background options would be populated here -->
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Panel -->
            <div id="right-panel" x-data>
                <!-- Sidebar Header -->
                <div class="sidebar-header">
                    <div class="product-info">
                        <div class="product-name"
                            x-text="$store.designer.product?.name || '{{ current_product.name }}'"></div>
                        <div class="design-name" x-text="$store.designer.designName" id="design-name-display"></div>
                    </div>
                    <div class="header-icons">
                        <button class="header-icon-btn" @click="editDesignName()" title="Edit Design Name">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="header-icon-btn" id="account-popover-btn" data-bs-toggle="popover"
                            data-bs-placement="bottom" data-bs-html="true" data-bs-trigger="click" title="Account">
                            <i class="bi bi-person"></i>
                        </button>
                    </div>
                </div>

                <!-- Layer Tabs -->
                <div class="layer-tabs-section">
                    <div class="layer-tabs" id="layer-tabs">
                        <template x-for="(layer, layerId) in $store.designer.layers" :key="layerId">
                            <button class="layer-tab" :class="{ 'active': $store.designer.currentLayer === layerId }"
                                @click="$store.designer.setCurrentLayer(layerId)" x-text="layer.name">
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Design Content -->
                <div class="design-content">
                    <!-- Color Section -->
                    <div class="design-section" x-data="{
                             get layerColor() { 
                                 return $store.designer.getCurrentLayerData().color || 'ffffff'; 
                             },
                             get hexValue() {
                                 return '#' + this.layerColor;
                             }
                         }">
                        <h6 class="design-section-label">Color</h6>
                        <div class="color-controls">
                            <div class="color-input-group">
                                <div class="color-picker-wrapper">
                                    <input type="color" class="form-control form-control-color" :value="hexValue"
                                        @input="$store.designer.setLayerColor($event.target.value)">
                                </div>
                                <div class="hex-input-wrapper">
                                    <span class="hex-prefix">#</span>
                                    <input type="text" class="form-control form-control-sm hex-input"
                                        placeholder="FFFFFF" maxlength="6" :value="layerColor"
                                        @input="$store.designer.setLayerColor('#' + $event.target.value)">
                                </div>
                                <button class="copy-color-btn" type="button" data-bs-toggle="popover"
                                    data-bs-placement="bottom" data-bs-html="true" title="Copy Color to Other Layers">
                                    <i class="bi bi-palette"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Material Section -->
                    <div class="design-section">
                        <h6 class="design-section-label">Material</h6>
                        <div class="material-grid" id="material-options">
                            <!-- Material options will be populated here -->
                        </div>
                    </div>

                    <!-- Designs Section -->
                    <div class="design-section">
                        <div class="design-section-header">
                            <h6 class="design-section-label">Designs</h6>
                            <div class="dropdown">
                                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="addDesignBtn"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Add Design
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="addDesignBtn">
                                    <li>
                                        <h6 class="dropdown-header">Add Design</h6>
                                    </li>
                                    <li><a class="dropdown-item" href="#" @click="$store.ui.openImageBank()"
                                            data-bs-dismiss="dropdown">
                                            <i class="bi bi-image me-2"></i>Image
                                        </a></li>
                                    <li><a class="dropdown-item" href="#"
                                            @click="$store.designer.addDecal('text', { text: 'Sample Text', font: 'Roboto', color: '000000' })"
                                            data-bs-dismiss="dropdown">
                                            <i class="bi bi-fonts me-2"></i>Text
                                        </a></li>
                                    <li><a class="dropdown-item" href="#" @click="$store.designer.addDecal('fade', {})"
                                            data-bs-dismiss="dropdown">
                                            <i class="bi bi-circle-half me-2"></i>Fade
                                        </a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="design-elements-list" id="decals-list">
                            <template x-for="decal in $store.designer.getCurrentLayerData().decals || []"
                                :key="decal.id">
                                <div class="design-element-item"
                                    :class="{ 'active': $store.designer.selectedDecal === decal.id }"
                                    @click="$store.designer.selectDecal(decal.id)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="decal-info">
                                            <div class="decal-name"
                                                x-text="decal.name || (decal.type === 'text' ? decal.text : decal.type)">
                                            </div>
                                            <div class="decal-type text-muted" x-text="decal.type"></div>
                                        </div>
                                        <div class="decal-actions">
                                            <button class="btn btn-sm btn-outline-danger"
                                                @click.stop="$store.designer.deleteDecal(decal.id)" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div x-show="!$store.designer.getCurrentLayerData().decals?.length"
                                class="empty-state text-center text-muted py-4">
                                <i class="bi bi-plus-circle-dotted mb-2" style="font-size: 2rem;"></i>
                                <p>No designs added yet</p>
                                <small>Use "Add Design" to get started</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cart Section -->
                <div class="cart-section">
                    <h4 class="text-center mb-1">Design Actions</h4>
                    <p class="text-muted mb-3 text-center">Save and order your design</p>

                    <!-- Icon Action Buttons Grid -->
                    <div class="action-buttons-grid">
                        {% if not create_template %}
                        <!-- Save Design (only show for regular designs) -->
                        <button class="action-btn" @click="$store.designer.saveDesign()">
                            <i class="bi bi-save"></i>
                            <span>Save</span>
                        </button>

                        <!-- Templates (only show for regular designs) -->
                        <button class="action-btn" @click="$store.ui.openTemplates()">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <span>Templates</span>
                        </button>
                        {% endif %}

                        <!-- Clear Design -->
                        <button class="action-btn"
                            @click="confirm('Are you sure you want to clear the design?') && $store.designer.clearDesign()">
                            <i class="bi bi-arrow-clockwise"></i>
                            <span>Clear</span>
                        </button>

                        <!-- Exit Designer -->
                        <button class="action-btn"
                            @click="confirm('Are you sure you want to exit the designer?') && (window.location.href = '/products/')">
                            <i class="bi bi-box-arrow-left"></i>
                            <span>Exit</span>
                        </button>
                    </div>

                    <!-- Add to Cart Button Row -->
                    <div class="mt-3">
                        <button class="btn btn-primary w-100" @click="$store.ui.openCartModal()" id="add-cart-btn">
                            <i class="bi bi-cart-plus"></i> <span>Add to Cart</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine.js Modals -->
    <!-- Image Bank Modal -->
    <template x-if="$store.ui.showImageBank">
        <div x-transition.opacity class="modal fade" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; display: flex; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5);"
            @click.self="$store.ui.closeImageBank()">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Image Bank</h5>
                        <button type="button" class="btn-close" @click="$store.ui.closeImageBank()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center py-4">
                            <i class="bi bi-images" style="font-size: 3rem; color: #ccc;"></i>
                            <h6>Image Bank</h6>
                            <p class="text-muted">Image bank functionality would go here</p>
                            <button class="btn btn-primary"
                                @click="$store.designer.addDecal('image', {src: '/static/logo-dark.png', name: 'Sample Image'})">
                                Add Sample Image
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Templates Modal -->
    <template x-if="$store.ui.showTemplates">
        <div x-transition.opacity class="modal fade" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; display: flex; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5);"
            @click.self="$store.ui.closeTemplates()">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Templates</h5>
                        <button type="button" class="btn-close" @click="$store.ui.closeTemplates()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center py-4">
                            <i class="bi bi-grid-3x3-gap" style="font-size: 3rem; color: #ccc;"></i>
                            <h6>Design Templates</h6>
                            <p class="text-muted">Template library would go here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Cart Modal -->
    <template x-if="$store.ui.showCartModal">
        <div x-transition.opacity class="modal fade" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; display: flex; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5);"
            @click.self="$store.ui.closeCartModal()">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add to Cart</h5>
                        <button type="button" class="btn-close" @click="$store.ui.closeCartModal()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center py-4">
                            <i class="bi bi-cart-plus" style="font-size: 3rem; color: #ccc;"></i>
                            <h6>Cart Options</h6>
                            <p class="text-muted">Size selection and cart functionality would go here</p>
                            <button class="btn btn-success">Add to Cart</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Original Image Bank Modal (keeping for reference) -->
    <div class="modal fade image-bank-modal" id="imageBankModal" tabindex="-1" aria-labelledby="imageBankModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-body">
                    <!-- Modal content will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Save Design Modal -->
    <div class="modal fade" id="saveDesignModal" tabindex="-1" aria-labelledby="saveDesignModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveDesignModalLabel">Save Design</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="design-name-input" class="form-label">Design Name</label>
                        <input type="text" class="form-control" id="design-name-input" placeholder="Enter design name">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="make-public">
                        <label class="form-check-label" for="make-public">
                            Make this design public
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-design-confirm">Save Design</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-cart">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cartModalLabel">Select Sizes & Quantities</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body cart-modal-body">
                    <!-- Cart content will be generated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-add-to-cart">Add to Cart</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Data -->
    <script>
        // Pass PHP data to JavaScript (matching original PHP structure)
        window.phpData = {
            environment: '{{ settings.DEBUG|yesno:"development,production" }}',
            user: {% if user.is_authenticated %}{ 'name': '{{ user.first_name|default:"" }} {{ user.last_name|default:"" }}', 'email': '{{ user.email|default:"" }}' }{% else %}null{% endif %},
            isGuest: {{ is_guest|yesno:"true,false" }},
            isBrandOwner: {{ is_brand_owner|yesno:"true,false" }},
            userBrand: {% if user.is_authenticated and is_brand_owner %}{ 'id': {{ current_brand.id|default:0 }}, 'name': '{{ current_brand.name|default:"" }}' }{% else %}null{% endif %},
            brand: {
                id: {{ current_brand.id|default:0 }},
                name: '{{ current_brand.name|default:"" }}',
                primaryColor: '{{ current_brand.primary_color|default:"#000000" }}'
            },
            product: {{ current_product_json|safe }},
            bumpmaps: {{ bumpmaps|safe }},
            fonts: {{ fonts|safe }},
            imageBank: {
                categories: [],
                initialImages: [],
                loadedAt: {% now "U" %}
            },
            designData: {% if design_data %}{{ design_data|safe }}{% else %}null{% endif %},
            createTemplate: {{ create_template|yesno:"true,false" }},
            templateEditId: null,
            brandBackgrounds: []
        };

        // For backward compatibility
        window.designerData = window.phpData;

        // Alpine.js will handle loading state automatically through the store
    </script>

    <!-- Scripts -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/three.min.js' %}"></script>
    <script src="{% static 'js/OrbitControls.js' %}"></script>
    <script src="{% static 'js/GLTFLoader.js' %}"></script>
    <script src="{% static 'js/RGBELoader.js' %}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="{% static 'js/designer-alpine.js' %}"></script>
</body>

</html>