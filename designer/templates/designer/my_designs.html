{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - {{ current_brand.name }}{% endblock %}

{% block content %}
{% csrf_token %}
    
<div class="container my-5">
        <div class="row">
            <!-- Sidebar - only show for logged-in users -->
            {% if not is_guest %}
                <div class="col-lg-3 col-md-4 mb-4">
                    <!-- Account sidebar would go here -->
                    <div class="card">
                        <div class="card-body">
                            <h6>Account Menu</h6>
                            <nav class="nav flex-column">
                                <a class="nav-link active" href="{% url 'designer:my_designs' %}">My Designs</a>
                                <a class="nav-link" href="/account">Account Settings</a>
                            </nav>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Main Content -->
            <div class="{% if is_guest %}col-12{% else %}col-lg-9 col-md-8{% endif %}">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h2 mb-1">My Designs</h1>
                        <p class="text-muted mb-0">
                            {% if is_guest %}
                                Your designs are saved temporarily. <a href="/register">Create an account</a> to save them permanently.
                            {% else %}
                                Manage and edit your custom designs
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-end d-none d-lg-block">
                        <a href="/designer/" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Create New Design
                        </a>
                    </div>
                </div>

                <!-- Design Statistics -->
                <div class="row mb-4">
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-body d-flex align-items-center">
                                <div class="text-primary me-4">
                                    <i class="bi bi-palette" style="font-size: 2rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="text-muted mb-0 small">Total Designs</p>
                                    <h5 class="mb-1">{{ total_designs }}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-body d-flex align-items-center">
                                <div class="text-info me-4">
                                    <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="text-muted mb-0 small">Recent Designs</p>
                                    <h5 class="mb-1">{{ recent_designs }}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-body d-flex align-items-center">
                                <div class="text-success me-4">
                                    <i class="bi bi-box-seam" style="font-size: 2rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="text-muted mb-0 small">Products Designed</p>
                                    <h5 class="mb-1">{{ products_designed }}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Designs Grid -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <div class="row align-items-center">
                            <div class="col-12 col-md-4 mb-3 mb-md-0">
                                <h5 class="mb-0"><i class="bi bi-grid-3x3 me-2 text-primary"></i>All Designs</h5>
                            </div>
                            <div class="col-12 col-md-8">
                                <div class="row align-items-center justify-content-end">
                                    <div class="col-12 col-lg-10">
                                        <form method="GET" action="{% url 'designer:my_designs' %}" class="row g-2">
                                            <div class="col-12 col-sm-6 col-lg-4">
                                                <select class="form-select" name="order" onchange="this.form.submit()">
                                                    <option value="updated_desc" {% if order_by == 'updated_desc' %}selected{% endif %}>Recently Updated</option>
                                                    <option value="updated_asc" {% if order_by == 'updated_asc' %}selected{% endif %}>Oldest Updated</option>
                                                    <option value="created_desc" {% if order_by == 'created_desc' %}selected{% endif %}>Recently Created</option>
                                                    <option value="created_asc" {% if order_by == 'created_asc' %}selected{% endif %}>Oldest Created</option>
                                                    <option value="name_asc" {% if order_by == 'name_asc' %}selected{% endif %}>Name A-Z</option>
                                                    <option value="name_desc" {% if order_by == 'name_desc' %}selected{% endif %}>Name Z-A</option>
                                                </select>
                                            </div>
                                            <div class="col-12 col-sm-6 col-lg-5">
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                    <input type="text" class="form-control" name="search" id="searchInput" placeholder="Search designs..." value="{{ search }}">
                                                    {% if search %}
                                                    <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('searchInput').value=''; this.form.submit();">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-12 col-lg-3">
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="bi bi-search me-2"></i>Search
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if designs %}
                            <div class="row">
                                {% for design in designs %}
                                    <div class="col-lg-3 col-md-4 mb-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="position-relative">
                                                {% if design.thumbnail_front and design.thumbnail_front.url %}
                                                    <img src="{{ design.thumbnail_front.url }}" alt="Design Thumbnail" class="card-img-top" style="height: 200px; object-fit: contain;">
                                                {% else %}
                                                    <!-- Show product placeholder or design icon -->
                                                    <div class="card-img-top bg-gradient d-flex align-items-center justify-content-center position-relative" style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                        <div class="text-center text-white">
                                                            <i class="bi bi-palette2" style="font-size: 3rem; opacity: 0.8;"></i>
                                                            <p class="mt-2 mb-0 fw-bold">Custom Design</p>
                                                            <small class="opacity-75">Product {{ design.product }}</small>
                                                        </div>
                                                        <!-- Badge to indicate no thumbnail -->
                                                        <div class="position-absolute top-0 end-0 m-2">
                                                            <span class="badge bg-warning text-dark">
                                                                <i class="bi bi-camera-slash" style="font-size: 10px;"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                                <!-- Visibility Badge -->
                                                <div class="position-absolute top-0 start-0 m-2">
                                                    {% if design.public %}
                                                        <span class="badge bg-success"><i class="bi bi-eye me-1"></i>Public</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary"><i class="bi bi-eye-slash me-1"></i>Private</span>
                                                    {% endif %}
                                                </div>
                                                <div class="position-absolute top-0 end-0 m-2">
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown">
                                                            <i class="bi bi-three-dots-vertical"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item" href="#" onclick="showRenameModal('{{ design.id }}', '{{ design.name|escapejs }}')"><i class="bi bi-pencil-square me-2"></i>Rename</a></li>
                                                            <li><a class="dropdown-item" href="/designer/?product={{ design.product }}&design={{ design.id }}"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                                            <li><a class="dropdown-item" href="#" onclick="showDuplicateModal('{{ design.id }}', '{{ design.name|escapejs }}')"><i class="bi bi-files me-2"></i>Duplicate</a></li>
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li><a class="dropdown-item" href="#" onclick="showShareModal('{{ design.id }}', '{{ design.name|escapejs }}', {{ design.public|yesno:'true,false' }})"><i class="bi bi-share me-2"></i>Share</a></li>
                                                            <li><a class="dropdown-item" href="#" onclick="toggleDesignVisibility('{{ design.id }}', {{ design.public|yesno:'true,false' }}, '{{ design.name|escapejs }}')">
                                                                <i class="bi bi-{% if design.public %}eye-slash{% else %}eye{% endif %} me-2"></i>{% if design.public %}Make Private{% else %}Make Public{% endif %}
                                                            </a></li>
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteModal('{{ design.id }}', '{{ design.name|escapejs }}')"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                {% if is_guest %}
                                                <div class="position-absolute bottom-0 start-0 m-2">
                                                    <span class="badge bg-warning text-dark"><i class="bi bi-clock-history me-1"></i>Temporary</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-title mb-2">{{ design.name|default:"Untitled Design" }}</h6>
                                                <p class="card-text text-muted small mb-2">
                                                    <i class="bi bi-tag me-1"></i><span class="product-name" data-product-id="{{ design.product }}">Product {{ design.product }}</span>
                                                </p>
                                                <p class="card-text text-muted small mb-2">
                                                    <i class="bi bi-calendar me-1"></i>Created {{ design.created_at|date:"M j, Y" }}
                                                </p>
                                                <p class="card-text text-muted small mb-3">
                                                    <i class="bi bi-clock me-1"></i>Updated {{ design.updated_at|date:"M j, Y" }}
                                                </p>
                                                <div class="d-flex gap-2">
                                                    <a href="/designer/?product={{ design.product }}&design={{ design.id }}" class="btn btn-primary btn-sm flex-fill">
                                                        <i class="bi bi-pencil me-2"></i>Edit Design
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                        {% else %}
                            <div class="text-center py-5">
                                {% if has_search_or_filter %}
                                    <i class="bi bi-funnel text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="mt-3 mb-2">No Designs Found</h4>
                                    <p class="text-muted mb-4">No designs match your current search or filter criteria. Try adjusting your search.</p>
                                    <a href="{% url 'designer:my_designs' %}" class="btn btn-primary">
                                        <i class="bi bi-x-circle me-2"></i>Clear Search & Filters
                                    </a>
                                {% else %}
                                    <i class="bi bi-palette text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="mt-3 mb-2">No Designs Yet</h4>
                                    <p class="text-muted mb-4">
                                        {% if is_guest %}
                                            Start creating your custom designs! They'll be saved temporarily until you create an account.
                                        {% else %}
                                            You haven't created any designs yet. Start designing to see your creations here.
                                        {% endif %}
                                    </p>
                                    <a href="/products/" class="btn btn-primary btn-lg">
                                        <i class="bi bi-plus-circle me-2"></i>Create Your First Design
                                    </a>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if designs.has_other_pages %}
                    <div class="card-footer bg-white py-3">
                        <div class="row align-items-center">
                            <div class="col-sm-12 col-md-5">
                                <p class="text-muted mb-0 text-center text-md-start mb-3 mb-md-0">
                                    Showing {{ designs.start_index }} - {{ designs.end_index }} of {{ designs.paginator.count }} designs
                                </p>
                            </div>
                            <div class="col-sm-12 col-md-7">
                                <nav aria-label="Design pagination">
                                    <ul class="pagination justify-content-center justify-content-md-end mb-0">
                                        <!-- Previous Page -->
                                        <li class="page-item {% if not designs.has_previous %}disabled{% endif %}">
                                            {% if designs.has_previous %}
                                                <a class="page-link" href="?page={{ designs.previous_page_number }}&search={{ search|urlencode }}&order={{ order_by|urlencode }}">
                                                    <i class="bi bi-chevron-left"></i>
                                                </a>
                                            {% else %}
                                                <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                                            {% endif %}
                                        </li>
                                        
                                        {% for num in designs.paginator.page_range %}
                                            {% if designs.number == num %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ num }}</span>
                                                </li>
                                            {% elif num > designs.number|add:'-3' and num < designs.number|add:'3' %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ num }}&search={{ search|urlencode }}&order={{ order_by|urlencode }}">{{ num }}</a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        <!-- Next Page -->
                                        <li class="page-item {% if not designs.has_next %}disabled{% endif %}">
                                            {% if designs.has_next %}
                                                <a class="page-link" href="?page={{ designs.next_page_number }}&search={{ search|urlencode }}&order={{ order_by|urlencode }}">
                                                    <i class="bi bi-chevron-right"></i>
                                                </a>
                                            {% else %}
                                                <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                                            {% endif %}
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Design Modal -->
    <div class="modal fade" id="renameDesignModal" tabindex="-1" aria-labelledby="renameDesignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="renameDesignModalLabel">
                        <i class="bi bi-pencil-square text-primary me-2"></i>
                        Rename Design
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="renameDesignForm">
                        <input type="hidden" id="rename-design-id">
                        <div class="mb-3">
                            <label for="new-design-name" class="form-label">Design Name</label>
                            <input type="text" class="form-control" id="new-design-name" placeholder="Enter new design name" maxlength="100" required>
                            <div class="form-text">Choose a descriptive name for your design (max 100 characters)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-rename-design-btn">
                        <i class="bi bi-check"></i> Save Name
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate Design Modal -->
    <div class="modal fade" id="duplicateDesignModal" tabindex="-1" aria-labelledby="duplicateDesignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateDesignModalLabel">
                        <i class="bi bi-files text-primary me-2"></i>
                        Duplicate Design
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="duplicateDesignForm">
                        <input type="hidden" id="duplicate-design-id">
                        <div class="mb-3">
                            <label for="duplicate-design-name" class="form-label">Name for Duplicated Design</label>
                            <input type="text" class="form-control" id="duplicate-design-name" placeholder="Enter name for the copy" maxlength="100" required>
                            <div class="form-text">Choose a name for your duplicated design (max 100 characters)</div>
                        </div>
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div>
                                <strong>This will create a copy with:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>All design data and 3D settings</li>
                                    <li>Same product and customizations</li>
                                    <li>Private visibility (you can change this later)</li>
                                    <li>New creation date</li>
                                </ul>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-duplicate-design-btn">
                        <i class="bi bi-files"></i> Create Duplicate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Design Visibility Modal -->
    <div class="modal fade" id="designVisibilityModal" tabindex="-1" aria-labelledby="designVisibilityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="designVisibilityModalLabel">
                        <i class="bi bi-eye text-info me-2"></i>
                        Change Design Visibility
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="visibility-design-id">
                    <input type="hidden" id="visibility-design-name">
                    <input type="hidden" id="visibility-new-state">
                    
                    <div id="make-public-content" class="d-none">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-eye text-success me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h6 class="mb-1">Make Design Public</h6>
                                <p class="text-muted mb-0">Your design will be visible to others</p>
                            </div>
                        </div>
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div>
                                <strong>Public designs are:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>Visible on the community gallery</li>
                                    <li>Can be shared with a direct link</li>
                                    <li>Discoverable by other users</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div id="make-private-content" class="d-none">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-eye-slash text-warning me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h6 class="mb-1">Make Design Private</h6>
                                <p class="text-muted mb-0">Your design will be viewable via link but not interactive</p>
                            </div>
                        </div>
                        <div class="alert alert-warning d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                            <div>
                                <strong>Making this design private will:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>Remove it from the community gallery</li>
                                    <li>Keep shared links working but view-only</li>
                                    <li>Prevent others from customizing or purchasing</li>
                                    <li>Allow sharing but restrict interactions</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-visibility-change-btn">
                        <i class="bi bi-check"></i> <span id="confirm-visibility-text">Confirm</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Design Confirmation Modal -->
    <div class="modal fade" id="deleteDesignModal" tabindex="-1" aria-labelledby="deleteDesignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteDesignModalLabel">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                        Delete Design
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to delete <strong id="delete-design-name"></strong>?</p>
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span>This action cannot be undone.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-design-btn">
                        <i class="bi bi-trash"></i> Delete Design
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Design Modal -->
    <div class="modal fade" id="shareDesignModal" tabindex="-1" aria-labelledby="shareDesignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareDesignModalLabel">
                        <i class="bi bi-share me-2"></i>
                        Share Design
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Design Name</label>
                        <p class="fw-bold" id="share-design-name"></p>
                    </div>
                    
                    <div class="mb-3" id="share-public-info" style="display: none;">
                        <div class="alert alert-success d-flex align-items-center">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span>This design is public and can be shared!</span>
                        </div>
                        
                        <label class="form-label">Share Link</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="share-link" readonly>
                            <button class="btn btn-outline-primary" type="button" id="copy-share-link">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                        <small class="text-muted">Anyone with this link can view your design</small>
                    </div>
                    
                    <div class="mb-3" id="share-private-info" style="display: none;">
                        <div class="alert alert-warning d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>
                                <strong>This design is private</strong><br>
                                <small>To share this design, you need to make it public first.</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success w-100" id="make-public-for-share">
                            <i class="bi bi-eye me-2"></i>Make Design Public
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="#" id="view-share-page" target="_blank" class="btn btn-primary">
                        <i class="bi bi-box-arrow-up-right me-2"></i>View Share Page
                    </a>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
    <!-- Pass data to JavaScript -->
    <script>
        // Pass data to JavaScript  
        window.productsData = {{ products_data|safe }};
        window.isGuest = {{ is_guest|yesno:"true,false" }};
        window.currentBrand = {
            id: {{ current_brand.id|default:0 }},
            name: '{{ current_brand.name|default:""|escapejs }}',
            primaryColor: '{{ current_brand.primary_color|default:"#007bff"|escapejs }}'
        };
    </script>

    <script>
        // Helper function to get product name by ID
        function getProductNameById(productId) {
            const products = window.productsData || [];
            const product = products.find(p => p.id == productId);
            return product ? product.name : 'Unknown Product';
        }

        // Update product names in the UI
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.product-name').forEach(element => {
                const productId = element.getAttribute('data-product-id');
                element.textContent = getProductNameById(productId);
            });
        });


        // Rename Design Modal functionality
        let currentDesignToRename = null;

        function showRenameModal(designId, currentName) {
            currentDesignToRename = designId;
            document.getElementById('rename-design-id').value = designId;
            document.getElementById('new-design-name').value = currentName;
            
            const modal = new bootstrap.Modal(document.getElementById('renameDesignModal'));
            modal.show();
            
            // Focus on the input field
            setTimeout(() => {
                document.getElementById('new-design-name').focus();
                document.getElementById('new-design-name').select();
            }, 300);
        }

        // Handle rename form submission
        document.getElementById('confirm-rename-design-btn')?.addEventListener('click', function() {
            if (!currentDesignToRename) {
                return;
            }
            
            const newName = document.getElementById('new-design-name').value.trim();
            if (!newName) {
                alert('Please enter a design name');
                return;
            }
            
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            
            // Update the design name via our Django endpoint
            fetch('/designer/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    design_id: currentDesignToRename,
                    name: newName,
                    product: 1, // Will be ignored for updates but required by validation
                    data: {} // Will be ignored for updates but required by validation
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('renameDesignModal')).hide();
                    
                    // Refresh the page to update the design name
                    window.location.reload();
                } else {
                    alert('Error renaming design: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error renaming design. Please try again.');
            })
            .finally(() => {
                // Restore button state
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-check"></i> Save Name';
                currentDesignToRename = null;
            });
        });

        // Duplicate Design Modal functionality
        let currentDesignToDuplicate = null;

        function showDuplicateModal(designId, currentName) {
            currentDesignToDuplicate = designId;
            document.getElementById('duplicate-design-id').value = designId;
            document.getElementById('duplicate-design-name').value = currentName + ' - Copy';
            
            const modal = new bootstrap.Modal(document.getElementById('duplicateDesignModal'));
            modal.show();
            
            // Focus on the input field and select the text
            setTimeout(() => {
                const input = document.getElementById('duplicate-design-name');
                input.focus();
                input.select();
            }, 300);
        }

        // Share Design functionality
        function showShareModal(designId, designName, isPublic) {
            // Set design name
            document.getElementById('share-design-name').textContent = designName || 'Untitled Design';
            
            // Build share URL
            const shareUrl = window.location.origin + '/designer/share/' + designId + '/';
            
            // Set view share page link
            document.getElementById('view-share-page').href = shareUrl;
            
            if (isPublic) {
                // Show public share info
                document.getElementById('share-public-info').style.display = 'block';
                document.getElementById('share-private-info').style.display = 'none';
                document.getElementById('share-link').value = shareUrl;
            } else {
                // Show private info
                document.getElementById('share-public-info').style.display = 'none';
                document.getElementById('share-private-info').style.display = 'block';
                
                // Set up make public button
                document.getElementById('make-public-for-share').onclick = function() {
                    // Close share modal
                    bootstrap.Modal.getInstance(document.getElementById('shareDesignModal')).hide();
                    // Open visibility modal
                    toggleDesignVisibility(designId, false, designName);
                };
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('shareDesignModal'));
            modal.show();
        }
        
        // Copy share link functionality
        document.getElementById('copy-share-link')?.addEventListener('click', function() {
            const shareLink = document.getElementById('share-link');
            shareLink.select();
            shareLink.setSelectionRange(0, 99999); // For mobile devices
            
            navigator.clipboard.writeText(shareLink.value).then(() => {
                // Show success feedback
                const originalHtml = this.innerHTML;
                this.innerHTML = '<i class="bi bi-check"></i> Copied!';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-success');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    this.innerHTML = originalHtml;
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-primary');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        });
        
        // Toggle Design Visibility functionality
        function toggleDesignVisibility(designId, isCurrentlyPublic, designName) {
            const newPublicState = !isCurrentlyPublic;
            
            // Set up modal content
            document.getElementById('visibility-design-id').value = designId;
            document.getElementById('visibility-design-name').value = designName || 'Design';
            document.getElementById('visibility-new-state').value = newPublicState ? '1' : '0';
            
            // Show/hide appropriate content
            if (newPublicState) {
                document.getElementById('make-public-content').classList.remove('d-none');
                document.getElementById('make-private-content').classList.add('d-none');
                document.getElementById('confirm-visibility-text').textContent = 'Make Public';
            } else {
                document.getElementById('make-public-content').classList.add('d-none');
                document.getElementById('make-private-content').classList.remove('d-none');
                document.getElementById('confirm-visibility-text').textContent = 'Make Private';
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('designVisibilityModal'));
            modal.show();
        }

        // Handle visibility change confirmation
        document.getElementById('confirm-visibility-change-btn')?.addEventListener('click', function() {
            const designId = document.getElementById('visibility-design-id').value;
            const designName = document.getElementById('visibility-design-name').value;
            const newPublicState = document.getElementById('visibility-new-state').value === '1';
            
            if (!designId) {
                return;
            }
            
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
            
            // Update the design visibility via our dedicated endpoint
            fetch(`/designer/update-visibility/${designId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    public: newPublicState
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('designVisibilityModal')).hide();
                    
                    // Refresh the page to update the visibility state
                    window.location.reload();
                } else {
                    alert('Error updating design visibility: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating design visibility. Please try again.');
            })
            .finally(() => {
                // Restore button state
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-check"></i> <span id="confirm-visibility-text">Confirm</span>';
            });
        });

        // Delete Design Modal functionality
        let currentDesignToDelete = null;

        function showDeleteModal(designId, designName) {
            currentDesignToDelete = designId;
            document.getElementById('delete-design-name').textContent = designName;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteDesignModal'));
            modal.show();
        }

        document.getElementById('confirm-delete-design-btn')?.addEventListener('click', function() {
            if (!currentDesignToDelete) {
                return;
            }
            
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
            
            // Delete the design
            fetch(`/designer/delete/${currentDesignToDelete}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('deleteDesignModal')).hide();
                    
                    // Refresh the page to update the designs list
                    window.location.reload();
                } else {
                    alert('Error deleting design: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting design. Please try again.');
            })
            .finally(() => {
                // Restore button state
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-trash"></i> Delete Design';
                currentDesignToDelete = null;
            });
        });

        // Allow Enter key to submit forms
        document.getElementById('new-design-name')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('confirm-rename-design-btn').click();
            }
        });

        document.getElementById('duplicate-design-name')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('confirm-duplicate-design-btn').click();
            }
        });
    </script>

    <style>
        .pagination .page-link {
            color: {{ current_brand.primary_color|default:"#007bff" }};
        }
        .pagination .page-item.active .page-link {
            background-color: {{ current_brand.primary_color|default:"#007bff" }};
            border-color: {{ current_brand.primary_color|default:"#007bff" }};
            color: white;
        }
        .pagination .page-link:hover {
            color: {{ current_brand.primary_color|default:"#007bff" }};
            background-color: rgba(0, 123, 255, 0.1);
            border-color: {{ current_brand.primary_color|default:"#007bff" }};
        }
        .pagination .page-link:focus {
            color: {{ current_brand.primary_color|default:"#007bff" }};
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .pagination .page-item.disabled .page-link {
            color: #6c757d;
        }
    </style>
{% endblock %}